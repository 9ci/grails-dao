<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="9ci">
        <link rel="canonical" href="https://yakworks.github.io/gorm-tools/repository/intro/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Quick Start - Gorm Tools Grails Plugin</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Gorm Tools Grails Plugin</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">Overview</a>
                    </li>
                    <li >
                        <a href="../../release-notes/">Release Notes</a>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Repository Pattern <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li class="active">
    <a href="./">Quick Start</a>
</li>
                            
<li >
    <a href="../ref/">Reference</a>
</li>
                            
<li >
    <a href="../databinding/">Databinding</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../queries-mango/">Mango Query</a>
                    </li>
                    <li >
                        <a href="../../async/">Async</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Toolbox <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../id-generation/">Id Generation</a>
</li>
                            
<li >
    <a href="../../gorm-utils/">GormUtils Class</a>
</li>
                            
<li >
    <a href="../../beanPathTools/">Bean Path Tools</a>
</li>
                            
<li >
    <a href="../../working-with-dates/">Date Utils</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../testing/">Testing</a>
                    </li>
                    <li >
                        <a href="../../api-docs/">API Docs</a>
                    </li>
                    <li >
                        <a href="../../usefulLinks/">Useful Links</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../../release-notes/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../ref/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/yakworks/gorm-tools">yakworks/gorm-tools
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#quick-start-example">Quick Start Example</a></li>
            <li><a href="#domain-setup">Domain setup</a></li>
            <li><a href="#stock-grails-gorm">Stock Grails Gorm</a></li>
            <li><a href="#using-the-repository">Using the Repository</a></li>
            <li><a href="#testing-the-domain">Testing the Domain</a></li>
            <li><a href="#implementing-projectrepo-service">Implementing ProjectRepo Service</a></li>
            <li><a href="#testing-the-projectrepo-changes">Testing the ProjectRepo Changes</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h2 id="quick-start-example">Quick Start Example</h2>
<p>To show what Repository data services are all about letâ€™s walk through an example.</p>
<h4 id="domain-setup">Domain setup</h4>
<p>Lets assume we are setting up a way to track details for this Project. We might setup a couple of domains like this. </p>
<pre><code class="groovy">//change the default contraints to be nullable:true
gorm.default.constraints = {
    '*'(nullable:true)
}

@GrailsCompileStatic
class Project {
    String name
    String description

    GitHubInfo gitHubInfo 


}

@GrailsCompileStatic
class GitHubInfo {
    Long repId         //1829344
    String slug         //yakworks/gorm-tools
    String description  //gorm tools for a clean shaved yak
}
</code></pre>

<p>and lets say we have a map, perhaps that came from a restful json request or some other service, test data etc...</p>
<pre><code class="groovy">params = [
    name: 'gorm-tools',
    gitHubInfo: [
        repId: 1829344,
        slug: 'yakworks/gorm-tools',
    ]
]
</code></pre>

<h3 id="stock-grails-gorm">Stock Grails Gorm</h3>
<p><strong>Using stock Grails</strong> <a href="http://gorm.grails.org/latest/hibernate/manual/index.html">Gorm</a>{.new-tab} we would probably implement something like the following 
simplified boiler plate design pattern for the <strong>C</strong> in CRUD</p>
<pre><code class="groovy">@GrailsCompileStatic @Transactional
class ProjectService {

    Project createNew(Map data){
        def project = new Project()
        project.properties = data
        project.save(failOnError:true) //throw runtime to roll back if error
    }

    //.... other imps
}

// elsewhwere, probably in a controller action, we would inject the service and use it to save
@Autowired ProjectService projectService
...
projectService.createNew(params)

</code></pre>

<p>or perhaps we would do it with the new Data Services</p>
<h3 id="using-the-repository">Using the Repository</h3>
<p><strong>With this Gorm repository plugin</strong>, we have shaved the yak for you and each domain has a Repository automatically 
setup for this pattern. So with this plugin all the boiler plate from above can be replaced with 1 line!</p>
<pre><code class="groovy">// elsewhere, probably in a controller action. 
Project.create(params)
</code></pre>

<p>Thats it. The <code>Project.create()</code> actually delegates to the Default<a href="https://yakworks.github.io/gorm-tools/api/gorm/tools/repository/GormRepo.html">GormRepo</a>.create(). The <code>create</code> is wrapped in a transaction, creates the intance,
binds the data and defaults to saving with <code>failOnError:true</code>. 
Like all transactional methods if the method is called from inside another transaction it will use it
otherwise it creates a new one. </p>
<blockquote>
<p>:bulb: <strong>Other Repository Domain Methods</strong><br />
You can do the same thing as above for an <code>update</code> or <code>delete</code>. 
The details of whats available can be seen in the <a href="https://yakworks.github.io/gorm-tools/api/gorm/tools/repository/GormRepoEntity.html">GormRepoEntity</a>{.new-tab} trait or in the <a href="https://github.com/yakworks/gorm-tools/blob/master/plugin/src/main/groovy/gorm/tools/repository/GormRepoEntity.groovy">GormRepoEntity source</a>{.new-tab} and are outlined below</p>
</blockquote>
<h3 id="testing-the-domain">Testing the Domain</h3>
<p>If you used the script to create the domains then the tests will already be in place for us or you can add one manually like so.</p>
<pre><code class="groovy">package testing

import gorm.tools.testing.hibernate.AutoHibernateSpec
import spock.lang.Specification

class ProjectSpec extends AutoHibernateSpec&lt;Project&gt; {
    /** automatically runs tests on persist(), create(), update(), delete().*/
}
</code></pre>

<p>Notice the absence of test methods? Running with the the mantra of "convetion over configuration" and "intelligent defaults"
<code>DomainAutoTest</code> will mock the domain, setup and create the data for you then exercise the domain and the default repository service for you.
We'll see in the next section how to override the automated tests in the DomainAutoTest. </p>
<h3 id="implementing-projectrepo-service">Implementing ProjectRepo Service</h3>
<p>The <a href="https://yakworks.github.io/gorm-tools/api/gorm/tools/repository/DefaultGormRepo.html">DefaultGormRepo</a> that is setup for the Project domain will of course not always be adequate for the business logic.
Again running with the "intelligent defaults but easy to override" mantra we can easily and selectively override the defaults in the repository. 
Lets say we want to do something more advanced during the create such as validate and retrieve info from GitHub. 
Its not recomended to autowire beans into the domains for performance reasons
It can also be tricky and at times fairly messy trying to modify or create domains using gorm's hibernate inspired event methods.
Such as <code>beforeCreate</code> inside the Project domain and deal with flushing.</p>
<p>We can abstract out the logic into a ProjectRepo. </p>
<p>Lets say we wanted to use a service to validate Github repo and retrieve the description on create.
We can add a class to the <code>grails-app/repository</code> directory as in the following example.</p>
<pre><code class="groovy">package tracker

@CompileStatic
class ProjectRepo implements GormRepo&lt;Project&gt;{

    @Autowired GitHubApi gitHubApi

    //event method used to update the descriptions with the ones in github
    @RepoListener
    void afterBind(Project project, Map params, AfterBindEvent be){
        Map repoInfo = gitHubApi.getGitRepo(params.gitHubRepo)
        //check that it was found using the slug or repoId
        if (!repoInfo) 
            throw new DataRetrievalFailureException(&quot;Github Repo is invalid for ${params.gitHubInfo}&quot;)

        if(repoInfo.description){
            //force the gitHubRepo.description to be whats in github
            project.gitHubInfo.description = repoInfo.description
            //update project.description to be the same if its null
            project.description = project.description ?: repoInfo.description
            project.persist() //optional
        }
    }
}

// elsewhere, you can call and it will be automatically taken care of
Project.create(params)

</code></pre>

<p>Events methods and fired spring events are run inside the inherited transaction and as usual an uncaught runtime exception will rollback.
The <code>persist</code> methods is another addition to the domains added by the GormRepoEntity trait. In the example above its not really needed as 
the changes will be flushed during the transaction commit. They are here to doc whats happening 
and so that validation failures can be easily seen.</p>
<h3 id="testing-the-projectrepo-changes">Testing the ProjectRepo Changes</h3>
<p><a href="https://yakworks.github.io/gorm-tools/api/gorm/tools/testing/DomainAutoTest.html">DomainAutoTest</a> already contains default tests for <code>create</code>, <code>update</code>, <code>persist</code>, <code>delete</code> methods, that are called from 
repo. So if, for example, any changes were made for create method for ProjectRepo:</p>
<pre><code class="groovy">@GormRepository
class ProjectRepo implements GormRepo&lt;Project&gt; {

    @Override
    @CompileDynamic
    Org create(Map params) {
        params.name = &quot;#&quot; + params.name 
        super.create(params)
     }
}
</code></pre>

<p>then you can override test case to check specific value </p>
<pre><code class="groovy">class ProjectSpec extends DomainAutoTest&lt;Project&gt; {

    void test_create() {
            when:
            D entity = getDomainClass().create(values)
            then:
            entity.id != null
            entity.name[0] == &quot;#&quot;
        }

}
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2020 9ci Inc</p>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
